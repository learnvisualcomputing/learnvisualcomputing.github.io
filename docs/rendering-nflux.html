<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>15&nbsp; The N-Flux Theory – Foundations of Visual Computing</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./imaging.html" rel="next">
<link href="./rendering-rte.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-485d01fc63b59abcd3ee1bf1e8e2748d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./rendering.html">Rendering</a></li><li class="breadcrumb-item"><a href="./rendering-nflux.html"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">The N-Flux Theory</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Foundations of Visual Computing</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">An Invitation to Visual Computing</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./hvs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Human Visual System</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hvs-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">From Light to Vision</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hvs-receptor.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Photoreceptors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hvs-color.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Color Vision</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hvs-colorimetry.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Colorimetry</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hvs-retinalmodel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Modeling Retinal Computation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hvs-adaptation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Visual Adaptations and Constancy</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./rendering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Rendering</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rendering-overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Overview</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rendering-radiometry.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Radiometry and Photometry</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rendering-lightfield.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Light Field</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rendering-re.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Rendering Equation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rendering-surfacemodeling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Modeling Material Surface</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rendering-sss.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Volume and Subsurface Scattering Processes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rendering-rte.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Radiative Transfer Equation and Volume Rendering</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rendering-nflux.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">The N-Flux Theory</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./imaging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Imaging</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./imaging-optics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Imaging Optics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./imaging-sensor.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Image Sensor Architecture</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./imaging-noise.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Noise</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./imaging-isp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Image Signal Processing</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./display.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Display</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./display-basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Basic Principles</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./display-impl.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Implementation Technologies</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-chpt-mat-vs-km" id="toc-sec-chpt-mat-vs-km" class="nav-link active" data-scroll-target="#sec-chpt-mat-vs-km"><span class="header-section-number">15.1</span> The Kubelka–Munk Model</a>
  <ul class="collapse">
  <li><a href="#sec-chpt-mat-vs-km-derivation" id="toc-sec-chpt-mat-vs-km-derivation" class="nav-link" data-scroll-target="#sec-chpt-mat-vs-km-derivation"><span class="header-section-number">15.1.1</span> Deriving the Model</a></li>
  <li><a href="#sec-chpt-mat-vs-km-model" id="toc-sec-chpt-mat-vs-km-model" class="nav-link" data-scroll-target="#sec-chpt-mat-vs-km-model"><span class="header-section-number">15.1.2</span> The Model and Its Interpretation</a></li>
  <li><a href="#sec-chpt-mat-vs-km-mix" id="toc-sec-chpt-mat-vs-km-mix" class="nav-link" data-scroll-target="#sec-chpt-mat-vs-km-mix"><span class="header-section-number">15.1.3</span> K-M Model for Mixture of Materials</a></li>
  <li><a href="#sec-chpt-mat-vs-km-cor" id="toc-sec-chpt-mat-vs-km-cor" class="nav-link" data-scroll-target="#sec-chpt-mat-vs-km-cor"><span class="header-section-number">15.1.4</span> Correction for Surface Reflection</a></li>
  </ul></li>
  <li><a href="#sec-chpt-mat-vs-km-nflux" id="toc-sec-chpt-mat-vs-km-nflux" class="nav-link" data-scroll-target="#sec-chpt-mat-vs-km-nflux"><span class="header-section-number">15.2</span> The N-Flux Model</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./rendering.html">Rendering</a></li><li class="breadcrumb-item"><a href="./rendering-nflux.html"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">The N-Flux Theory</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="sec-chpt-mat-vs-nf" class="quarto-section-identifier"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">The N-Flux Theory</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="hidden">
<p><span class="math display">\[
\def\oi{{\omega_i}}
\def\os{{\omega_s}}
\def\Oi{{\Omega_i}}
\def\Os{{\Omega_s}}
\def\d{{\text{d}}}
\def\D{{\Delta}}
\def\do{{\d\omega}}
\def\Do{{\Delta\omega}}
\def\doi{{\d\omega_i}}
\def\dos{{\d\omega_s}}
\def\Doi{{\D\omega_i}}
\def\Dos{{\D\omega_s}}
\def\H{{\mathbf{H}}}
\newcommand{\cM}{\mathcal{M}}
\newcommand{\cL}{\mathcal{L}}
\]</span></p>
</div>
<p>As discussed in <a href="rendering-rte.html#sec-chpt-mat-vs-rte-rte" class="quarto-xref"><span>Section 14.1</span></a>, the general RTE is difficult to solve, and there are two general strategies. <a href="rendering-rte.html#sec-chpt-mat-vs-rte-vre" class="quarto-xref"><span>Section 14.2</span></a> discusses one strategy that numerically approximates the solution using Monte Carlo methods. Another strategy is to make some simplified assumptions and/or apply additional constraints, which would allow us to derive analytical solutions. The most common form of this strategy is called the N-flux or N-stream theory. This chapter will start from the case where <span class="math inline">\(N=2\)</span>, which gives us the Kubelka–Munk Model (<a href="#sec-chpt-mat-vs-km" class="quarto-xref"><span>Section 15.1</span></a>), and then extend the theory to the general case (<a href="#sec-chpt-mat-vs-km-nflux" class="quarto-xref"><span>Section 15.2</span></a>).</p>
<section id="sec-chpt-mat-vs-km" class="level2" data-number="15.1">
<h2 data-number="15.1" class="anchored" data-anchor-id="sec-chpt-mat-vs-km"><span class="header-section-number">15.1</span> The Kubelka–Munk Model</h2>
<p>Kubelka and Munk, two Czechoslovakian chemists, built a phenomenological model that estimates the spectral reflectance/transmittance of a material <span class="citation" data-cites="kubelka1931beitrag kubelka1931article kubelka1948new">(<a href="references.html#ref-kubelka1931beitrag" role="doc-biblioref">Kubelka and Munk 1931b</a>, <a href="references.html#ref-kubelka1931article" role="doc-biblioref">1931a</a>; <a href="references.html#ref-kubelka1948new" role="doc-biblioref">Kubelka 1948</a>)</span>. Their model cares only about the hemispherical-hemispherical reflectance (<a href="rendering-re.html#sec-chpt-mat-ss-reflectance" class="quarto-xref"><span>Section 11.2</span></a>), i.e., the ratio of total flux scattered upward to the hemisphere to the total toward flux incident from the hemisphere. The K-M model also considers that the material under modeling is in immediate contact with a <em>Lambertian</em> substrate that reflects light uniformly over all directions. <!-- This is a common scenario in scenarios such as paints on a canvas, dyes on textiles, printer inks on paper, coatings on films, etc. --> The K-M model is the most aggressive form of simplification to the RTE that, nevertheless, is very widely used, especially in the printing, painting, and dye industry (and to some extent in graphics).</p>
<!-- %\fixme{diffuse assumption is technically wrong; use Fig. 2.5 in Bohren and the light absorption into a tube.} -->
<p>We will go through an excruciatingly long derivation, but the intuitions behind the derivation are exactly the same as that of the RTE, because the K-M model is a simplification of the RTE. The derivation allows us to make clear what simplifications we have made and, thus, when the model is and is not applicable.</p>
<section id="sec-chpt-mat-vs-km-derivation" class="level3" data-number="15.1.1">
<h3 data-number="15.1.1" class="anchored" data-anchor-id="sec-chpt-mat-vs-km-derivation"><span class="header-section-number">15.1.1</span> Deriving the Model</h3>
<p><a href="#fig-km_model" class="quarto-xref">Figure&nbsp;<span>15.1</span></a> illustrates the setup that we will use to derive the model. The first important assumption that the K-M model makes is that the every point on the material surface receives exactly the same irradiance and that the material itself is homogeneous, consisting of particles that are statistically randomly distributed and oriented. As a result, there is no difference between different positions at the same depth anywhere inside the material. Of course the radiation fields at different depths are different; at the very least, the deeper you go, the fewer photons there are due to absorption. Another way to think of this is that we are intentionally limiting our consideration to only a small area where there is no spatial difference at the same depth, so we can analyze information only at different depths rather than different positions at the same depth.</p>
<div id="fig-km_model" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-km_model-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/km_model.svg" class="img-fluid figure-img" style="width:70.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-km_model-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.1: The setup of deriving the K-M model. We focus on the change of downward irradiance (<span class="math inline">\(E_{\downarrow}\)</span>) and upward irradiance (<span class="math inline">\(E_{\uparrow}\)</span>) as they travel a thin layer <span class="math inline">\(\D x\)</span>. We make the assumption that the material is an isotropic medium and is homogeneous spatially.
</figcaption>
</figure>
</div>
<p>We focus on a very thin layer <span class="math inline">\(\D x\)</span>; since there are no differences between horizontal positions, we can arbitrarily pick a point at depth <span class="math inline">\(0 \leq x \leq X\)</span> for analysis, where <span class="math inline">\(X\)</span> is the total depth (the material surface has <span class="math inline">\(x=0\)</span> and the material bottom has <span class="math inline">\(x=X\)</span>). The point at <span class="math inline">\(x\)</span> receives photons from all directions. Let’s say all the downward photons (going to the lower hemisphere) have a total irradiance of <span class="math inline">\(E_{\downarrow}(x)\)</span> and all the upward photons (going to the upper hemisphere) have a total irradiance of <span class="math inline">\(E_{\uparrow}(x)\)</span>. The (hemispherical-hemispherical) reflectance at <span class="math inline">\(x\)</span> is then the ratio of the two:</p>
<p><span class="math display">\[
\begin{align}
    R(x) = \frac{E_{\uparrow}(x)}{E_{\downarrow}(x)},
\end{align}
\]</span></p>
<p>and the reflectance at the material surface (which is what the K-M model is interested in calculating) is <span class="math inline">\(R(0)\)</span>.</p>
<p>How do we express <span class="math inline">\(E_{\downarrow}(x)\)</span>? As usual, we set a differential equation to describe the change of <span class="math inline">\(E_{\downarrow}(x)\)</span>. Consider the following conservation of energy when <span class="math inline">\(E_{\downarrow}(x)\)</span> goes through the thin layer <span class="math inline">\(\D x\)</span>:</p>
<p><span id="eq-km_raw"><span class="math display">\[
\begin{align}
    E_{\downarrow}(x + \D x) - E_{\downarrow}(x) = &amp; - \int^{S^2_+}\sigma_a(x, \omega) \D x L(x, \omega) \do \label{eq:km_down_1} \\
    &amp; - \int^{S^2_+}\int^{S^2_+}\sigma_s(x, \omega) f_p(x, \omega', \omega) \D x L(x, \omega) \do' \do \label{eq:km_down_2} \\
    &amp; + \int^{S^2_-}\int^{S^2_-}\sigma_s(x + \D x, \omega) f_p(x + \D x, \omega', \omega) \D x L(x + \D x, \omega) \do' \do,  \label{eq:km_down_3}
\end{align}
\tag{15.1}\]</span></span></p>
<p>where <span class="math inline">\(S^2_+\)</span> and <span class="math inline">\(S^2_-\)</span> represent the upper and lower hemispheres, respectively; <span class="math inline">\(L(x, \omega)\)</span> is the radiance coming from direction <span class="math inline">\(\omega\)</span> incident on a point of depth <span class="math inline">\(x\)</span>, <span class="math inline">\(f_p(x, \omega', \omega)\)</span> is the phase function between the incident direction <span class="math inline">\(\omega\)</span> and outgoing direction <span class="math inline">\(\omega'\)</span>, and <span class="math inline">\(\sigma_s(x, \omega)\)</span> is the scattering coefficient at <span class="math inline">\(x\)</span> for an incident direction <span class="math inline">\(\omega\)</span> (<a href="rendering-sss.html#sec-chpt-mat-vs-sca-single" class="quarto-xref"><span>Section 13.2.2</span></a>).</p>
<p>The interpretation of this equation is exactly the same as that of the RTE. The equation essentially says that the downward irradiance after traveling <span class="math inline">\(\D x\)</span> is (omitting emission):</p>
<ul>
<li>reduced by absorption (the first negative term in <a href="#eq-km_raw" class="quarto-xref">Equation&nbsp;<span>15.1</span></a>), which is the absorption component in the RTE;</li>
<li>reduced by upward scattering (the second negative term in <a href="#eq-km_raw" class="quarto-xref">Equation&nbsp;<span>15.1</span></a>), which is the out-scattering component in the RTE;</li>
<li>increased by the downward-scattering of upward irradiance reaching the bottom of the thin layer (the positive term in <a href="#eq-km_raw" class="quarto-xref">Equation&nbsp;<span>15.1</span></a>), which is the in-scattering component in RTE.</li>
</ul>
<p>Now let’s take a closer look at the absorption term in <a href="#eq-km_raw" class="quarto-xref">Equation&nbsp;<span>15.1</span></a> and re-write it:</p>
<p><span id="eq-km_s_2"><span class="math display">\[
\begin{align}
    \int^{S^2_+}\sigma_a(x, \omega) \D x L(x, \omega) \do = \sigma_a(x, \bar{\omega}) \D x \int^{S^2_+} L(x, \omega) \do.
\end{align}
\tag{15.2}\]</span></span></p>
<p><a href="#eq-km_s_2" class="quarto-xref">Equation&nbsp;<span>15.2</span></a> is derived based on the <strong>mean-value theorem</strong><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> in integral calculus, which says that there exists <em>some</em> value of <span class="math inline">\(\bar{\omega}\in S^2_+\)</span> that would allow us to take the <span class="math inline">\(\sigma_a\)</span> term out of the integral. Once we do that, the integral on the right-hand side of <a href="#eq-km_s_2" class="quarto-xref">Equation&nbsp;<span>15.2</span></a> is simply the total downward irradiance, which we denote <span class="math inline">\(E_{\downarrow}(x)\)</span>.</p>
<p>If we further assume that the material absorption is isotropic, then <span class="math inline">\(\sigma_a(x, \bar{\omega})\)</span> is independent of <span class="math inline">\(\bar{\omega}\)</span> and is simply a function of <span class="math inline">\(x\)</span>, so we write it as <span class="math inline">\(K_{\downarrow}(x)\)</span>, which allows us to re-write <a href="#eq-km_s_2" class="quarto-xref">Equation&nbsp;<span>15.2</span></a> as:</p>
<p><span id="eq-km_s_3"><span class="math display">\[
\begin{align}
    \int^{S^2_+}\sigma_a(x, \omega) \D x L(x, \omega) \do = K_{\downarrow}(x) \D x E_{\downarrow}(x).
\end{align}
\tag{15.3}\]</span></span></p>
<p><span class="math inline">\(K_{\downarrow}(x)\)</span> is a phenomenological coefficient, but it is related to the fundamental absorption coefficient <span class="math inline">\(\sigma_a\)</span> and, thus, carries physical meanings. This is clear from <a href="#eq-km_s_4" class="quarto-xref">Equation&nbsp;<span>15.4</span></a>:</p>
<p><span id="eq-km_s_4"><span class="math display">\[
\begin{align}
    K_{\downarrow}(x) = \frac{\int^{S^2_+}\sigma_a(x, \omega) L(x, \omega) \do}{\D x E_{\downarrow}(x)}.
\end{align}
\tag{15.4}\]</span></span></p>
<p><span class="math inline">\(K_{\downarrow}(x)\)</span>, by definition, represents the fraction of downward irradiance that is absorbed per unit length. Therefore, <span class="math inline">\(K_{\downarrow}(x)\)</span> can be intuitively interpreted as the effective <em>downward absorption coefficient</em> at depth <span class="math inline">\(x\)</span>. Note that while the mean-value theorem tells us that <em>some</em> <span class="math inline">\(\bar{\omega}\in S^2_+\)</span> exists, it does not tell us what its values is. In reality, <span class="math inline">\(K_{\downarrow}(x)\)</span> will very much depend on <span class="math inline">\(L(x, \omega)\)</span>.</p>
<p>Similarly, we can rewrite the upward scattering term in <a href="#eq-km_raw" class="quarto-xref">Equation&nbsp;<span>15.1</span></a> by first rearranging the terms:</p>
<p><span id="eq-km_ku_1b"><span class="math display">\[
\begin{align}
    &amp;\int^{S^2_+}\int^{S^2_+}\sigma_s(x, \omega) f_p(x, \omega', \omega) \D x L(x, \omega) \do' \do \\
    = &amp;\int^{S^2_+}\Big(\int^{S^2_+}\sigma_s(x, \omega) f_p(x, \omega', \omega) \do'\Big) \D x L(x, \omega) \do.
\end{align}
\tag{15.5}\]</span></span></p>
<p>We then invoke the mean-value theorem again, which says that there exists <span class="math inline">\(\bar{\omega}\in S^2_+\)</span> that allows us to write the upward scattering term as:</p>
<p><span id="eq-km_ku_2"><span class="math display">\[
\begin{align}
    (\int^{S^2_+}\sigma_s(x, \bar{\omega}) f_p(x, \omega', \bar{\omega}) \do' \D x) \int^{S^2_+}L(x, \omega) \do.
\end{align}
\tag{15.6}\]</span></span></p>
<p>We use <span class="math inline">\(S_{\downarrow\uparrow}(x)\)</span> to denote the first integral in <a href="#eq-km_ku_2" class="quarto-xref">Equation&nbsp;<span>15.6</span></a>: <span class="math inline">\(S_{\downarrow\uparrow}(x) = \int^{S^2_+}\sigma_s(x, \bar{\omega}) f_p(x, \omega', \bar{\omega}) \do'\)</span>, which means the upward scattering term can be simplied to:</p>
<p><span id="eq-km_ku_3"><span class="math display">\[
\begin{align}
    S_{\downarrow\uparrow}(x) \D x E_{\downarrow}(x).
\end{align}
\tag{15.7}\]</span></span></p>
<p>Combining <a href="#eq-km_ku_1b" class="quarto-xref">Equation&nbsp;<span>15.5</span></a> and <a href="#eq-km_ku_3" class="quarto-xref">Equation&nbsp;<span>15.7</span></a>, we get: <span id="eq-km_ku_4"><span class="math display">\[
\begin{align}
    S_{\downarrow\uparrow}(x) = &amp; \frac{\int^{S^2_+}\int^{S^2_+}\sigma_s(x, \omega) f_p(x, \omega', \omega) L(x, \omega) \do' \do}{\D x E_{\downarrow}(x)}.
\end{align}
\tag{15.8}\]</span></span></p>
<p><span class="math inline">\(S_{\downarrow\uparrow}(x)\)</span> is again a phenomenological coefficient that is related to the fundamental scattering coefficient. Its physical interpretation is clear from <a href="#eq-km_ku_4" class="quarto-xref">Equation&nbsp;<span>15.8</span></a>: it is the fraction of the downward irradiance that is scattered upward per unit length. We can think of it as the effective “upward scattering coefficient of the downward irradiance”.</p>
<p>Finally, we can do the same thing to the downward scattering term in <a href="#eq-km_raw" class="quarto-xref">Equation&nbsp;<span>15.1</span></a>:</p>
<p><span id="eq-km_kd_1"><span class="math display">\[
\begin{align}
    \int^{S^2_-}\int^{S^2_-}\sigma_s(x + \D x, \omega) f_p(x + \D x, \omega', \omega) \D x L(x + \D x, \omega) \do' \do
\end{align}
\tag{15.9}\]</span></span></p>
<p>by first invoking the mean-value theorem and re-express it as:</p>
<p><span id="eq-km_kd_2"><span class="math display">\[
\begin{align}
    (\int^{S^2_-}\sigma_s(x + \D x, \hat{\omega}) f_p(x + \D x, \omega', \hat{\omega}) \do' \D x) \int^{S^2_-}L(x + \D x, \omega) \do.
\end{align}
\tag{15.10}\]</span></span></p>
<p>We use <span class="math inline">\(S_{\uparrow\downarrow}(x)\)</span> to denote the first integral in <a href="#eq-km_kd_2" class="quarto-xref">Equation&nbsp;<span>15.10</span></a>. The second integral in <a href="#eq-km_kd_2" class="quarto-xref">Equation&nbsp;<span>15.10</span></a> is essentially the total upward irradiance at the depth <span class="math inline">\(x+\D x\)</span>, which we denote <span class="math inline">\(E_{\uparrow}(x + \D x)\)</span>. Therefore, the downward scattering term becomes:</p>
<p><span id="eq-km_kd_3"><span class="math display">\[
\begin{align}
    S_{\uparrow\downarrow}(x + \D x) \D x E_{\uparrow}(x + \D x).
\end{align}
\tag{15.11}\]</span></span></p>
<p>Combining <a href="#eq-km_kd_1" class="quarto-xref">Equation&nbsp;<span>15.9</span></a> and <a href="#eq-km_kd_3" class="quarto-xref">Equation&nbsp;<span>15.11</span></a>, we have:</p>
<p><span id="eq-km_kd_5"><span class="math display">\[
\begin{align}
    S_{\uparrow\downarrow}(x + \D x) = &amp; \frac{\int^{S^2_-}\int^{S^2_-}\sigma_s(x + \D x, \omega) f_p(x + \D x, \omega', \omega) \D x L(x + \D x, \omega) \do' \do}{\D x E_{\uparrow}(x + \D x)},\\
    S_{\uparrow\downarrow}(x) = &amp; \frac{\int^{S^2_-}\int^{S^2_-}\sigma_s(x, \omega) f_p(x, \omega', \omega) \D x L(x, \omega) \do' \do}{\D x E_{\uparrow}(x)}.
\end{align}
\tag{15.12}\]</span></span></p>
<p>Now plug <a href="#eq-km_s_3" class="quarto-xref">Equation&nbsp;<span>15.3</span></a>, <a href="#eq-km_ku_3" class="quarto-xref">Equation&nbsp;<span>15.7</span></a>, and <a href="#eq-km_kd_3" class="quarto-xref">Equation&nbsp;<span>15.11</span></a> back into <a href="#eq-km_raw" class="quarto-xref">Equation&nbsp;<span>15.1</span></a>, we get:</p>
<p><span class="math display">\[
\begin{align}
    E_{\downarrow}(x + \D x) = E_{\downarrow}(x) - K_{\downarrow}(x) \D x E_{\downarrow}(x) - S_{\downarrow\uparrow}(x) \D x E_{\downarrow}(x) + S_{\uparrow\downarrow}(x + \D x) \D x E_{\uparrow}(x + \D x).
\end{align}
\]</span></p>
<p>Rewrite it and take the limit as <span class="math inline">\(\D x \rightarrow 0\)</span>:</p>
<p><span id="eq-km_down"><span class="math display">\[
\begin{align}
    \frac{E_{\downarrow}(x + \D x) - E_{\downarrow}(x)}{\D x} &amp;= - K_{\downarrow}(x) E_{\downarrow}(x) - S_{\downarrow\uparrow}(x) E_{\downarrow}(x) + S_{\uparrow\downarrow}(x + \D x) E_{\uparrow}(x + \D x),\\
    \frac{\d E_{\downarrow}(x)}{\d x} &amp;= - K_{\downarrow}(x) E_{\downarrow}(x) - S_{\downarrow\uparrow}(x) E_{\downarrow}(x) + S_{\uparrow\downarrow}(x) E_{\uparrow}(x).
\end{align}
\tag{15.13}\]</span></span></p>
<p>Similarly we can express the rate of change of the upward irradiance <span class="math inline">\(E_{\uparrow}(x)\)</span> based on the same energy conservation constraint:</p>
<p><span id="eq-km_up"><span class="math display">\[
\begin{align}
    \frac{\d E_{\uparrow}(x)}{\d x} &amp;= K_{\uparrow}(x) E_{\uparrow}(x) + S_{\uparrow\downarrow}(x) E_{\uparrow}(x) - S_{\downarrow\uparrow}(x) E_{\downarrow}(x),
\end{align}
\tag{15.14}\]</span></span></p>
<p>where the three terms on the right-hand side, again, represent the absorption, out-scattering, and in-scattering in the original RTE.</p>
<p>Now a few more assumptions. If we assume that the material absorption is isotropic (the total absorption per unit length is invariant to incident light direction over the entire sphere), we have <span class="math inline">\(K_{\uparrow}(x) = K_{\downarrow}(x)\)</span> because:</p>
<p><span id="eq-km_abs_approx"><span class="math display">\[
\begin{align}
    K_{\uparrow}(x) = \sigma_a(x, \hat{\omega}) = \sigma_a(x, \bar{\omega}) = K_{\downarrow}(x),
\end{align}
\tag{15.15}\]</span></span></p>
<p>for some <span class="math inline">\(\hat{\omega} \in S^2_-\)</span> and <span class="math inline">\(\bar{\omega} \in S^2_+\)</span>.</p>
<p>If we further assume that 1) the material is an isotropic scattering medium, then <span class="math inline">\(\sigma_s(x, \omega)\)</span> is invariant to <span class="math inline">\(\omega\)</span> (the total amount of scattering per unit length does not change with the incident light direction over the entire sphere), and 2) the particles are also isotropic scatters (which theoretically do not exist), then <span class="math inline">\(f_p(x, \omega', \omega)\)</span> is a constant (<span class="math inline">\(\frac{1}{4\pi}\)</span>). Therefore, <span class="math inline">\(S_{\uparrow\downarrow}(x) = S_{\downarrow\uparrow}(x)\)</span>, because:</p>
<p><span id="eq-km_sca_approx"><span class="math display">\[
\begin{align}
    S_{\uparrow\downarrow}(x) &amp;= \int^{S^2_-}\sigma_s(x, \hat{\omega}) f_p(x, \omega', \hat{\omega}) \do' \\
    &amp;= \sigma_s(x, \hat{\omega}) \int^{S^2_-}f_p(x, \omega', \hat{\omega}) \do' = \sigma_s(x, \hat{\omega})/2 \\
    &amp;= \sigma_s(x, \bar{\omega}) \int^{S^2_-}f_p(x, \omega', \bar{\omega}) \do' = \sigma_s(x, \bar{\omega})/2 \\
    &amp;= S_{\downarrow\uparrow}(x),
\end{align}
\tag{15.16}\]</span></span></p>
<p>for some <span class="math inline">\(\hat{\omega} \in S^2_-\)</span> and <span class="math inline">\(\bar{\omega} \in S^2_+\)</span>.</p>
<p>A few notes on the assumptions here:</p>
<ul>
<li>The assumption of isotropic scatters is important; assuming only an isotropic medium is not enough. This is because the integrals in integrate only the upper (or lower) hemisphere rather than the entire sphere, so if the phase function itself is not a constant, the integral result will still depend on <span class="math inline">\(\bar{\omega}\)</span> or <span class="math inline">\(\hat{\omega}\)</span>. See the distinction between an isotropic medium and an isotropic scatter on <a href="rendering-sss.html#sec-chpt-mat-vs-sca-single-pf-iso" class="quarto-xref"><span>Section 13.2.3.2</span></a>.</li>
<li>Alternatively, if the particles are not isotropic scatters, <span class="math inline">\(S_{\uparrow\downarrow}(x) = S_{\downarrow\uparrow}(x)\)</span> can still hold if we assume that the upward and downward irradiance are both diffuse, i.e., the radiance <span class="math inline">\(L(x, \omega)\)</span> is invariant to <span class="math inline">\(\omega\)</span>. The isotropic medium assumption still needs to hold. This can be proven by going back to the respective definitions of <span class="math inline">\(S_{\uparrow\downarrow}(x)\)</span> and <span class="math inline">\(S_{\downarrow\uparrow}(x)\)</span> in <a href="#eq-km_ku_4" class="quarto-xref">Equation&nbsp;<span>15.8</span></a> and <a href="#eq-km_kd_5" class="quarto-xref">Equation&nbsp;<span>15.12</span></a><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. Interestingly, if the particles are isotropic scatters, the outgoing irradiance will necessarily be diffuse.</li>
<li>Yet another way for <span class="math inline">\(S_{\uparrow\downarrow}(x) = S_{\downarrow\uparrow}(x)\)</span> to hold is if we are considering a very idealized scenario where photons travel and are scattered only upward or downward <span class="citation" data-cites="bohren2006fundamentals">(<a href="references.html#ref-bohren2006fundamentals" role="doc-biblioref">Bohren and Clothiaux 2006</a>, Chpt. 5.2)</span>. If the medium is also isotropic (but does not have to consist of isotropic scatters), the fraction of the upward irradiance turned downward would be the same as the fraction of the downward irradiance turned upward, so <span class="math inline">\(S_{\uparrow\downarrow}(x) = S_{\downarrow\uparrow}(x)\)</span>.</li>
</ul>
<p>Finally, given the assumption that the material is spatially homogeneous, both <span class="math inline">\(\sigma_a\)</span>, <span class="math inline">\(\sigma_s\)</span>, and <span class="math inline">\(f_p\)</span> are all independent of <span class="math inline">\(x\)</span>. Therefore, we can denote <span class="math inline">\(K = K_{\uparrow}(x) = K_{\downarrow}(x)\)</span> and <span class="math inline">\(S = S_{\uparrow\downarrow}(x) = S_{\downarrow\uparrow}(x)\)</span>. <span class="math inline">\(K\)</span> and <span class="math inline">\(S\)</span> are simply called the absorption and scattering coefficients, respectively, of the medium, but we now should know that they are of the phenomenological nature and, with all the simplifications above, are derived from the fundamental optical absorption/scattering properties of the medium (see <a href="#eq-km_abs_approx" class="quarto-xref">Equation&nbsp;<span>15.15</span></a> and <a href="#eq-km_sca_approx" class="quarto-xref">Equation&nbsp;<span>15.16</span></a>).</p>
<p>Now we combine <a href="#eq-km_down" class="quarto-xref">Equation&nbsp;<span>15.13</span></a> and <a href="#eq-km_up" class="quarto-xref">Equation&nbsp;<span>15.14</span></a> and get to the famous pair of differential equations underlying the K-M model:</p>
<p><span id="eq-km_diff"><span class="math display">\[
\begin{align}
    \frac{\d E_{\downarrow}(x)}{\d x} &amp;= - (K +S)E_{\downarrow}(x) + S E_{\uparrow}(x), \\
    \frac{\d E_{\uparrow}(x)}{\d x} &amp;= (K + S)E_{\uparrow}(x) - S E_{\downarrow}(x).
\end{align}
\tag{15.17}\]</span></span></p>
</section>
<section id="sec-chpt-mat-vs-km-model" class="level3" data-number="15.1.2">
<h3 data-number="15.1.2" class="anchored" data-anchor-id="sec-chpt-mat-vs-km-model"><span class="header-section-number">15.1.2</span> The Model and Its Interpretation</h3>
<p><a href="#eq-km_diff" class="quarto-xref">Equation&nbsp;<span>15.17</span></a> gives us a pair of linear differential equations. What we are interested in solving for is <span class="math inline">\(R(0) = \frac{E_{\uparrow}(0)}{E_{\downarrow}(0)}\)</span>. The boundary condition is that <span class="math inline">\(R(X) = R_g\)</span>, which is the (assumed-to-be) known reflectance of the substrate. Solving the differential equations gives us:</p>
<p><span id="eq-km"><span class="math display">\[
\begin{align}
    &amp; R(0) = \frac{E_{\uparrow}(0)}{E_{\downarrow}(0)} = \frac{1-R_g[a-b\coth(bSX)]}{a-R_g+b\coth(bSX)},\\
    &amp; T(X) = \frac{E_{\downarrow}(X)}{E_{\downarrow}(0)} = \frac{b}{a\sinh(bSX)+b\cosh(bSX)},\\
    &amp; a = \frac{K+S}{S},\\
    &amp; b = \sqrt{a^2-1},
\end{align}
\tag{15.18}\]</span></span></p>
<p>where <span class="math inline">\(R(0)\)</span> is the hemispherical-hemispherical reflectance at the material surface and <span class="math inline">\(T(X)\)</span> is the hemispherical-hemispherical transmittance at the bottom of the material<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>; <span class="math inline">\(\coth(\cdot)\)</span> is the hyperbolic cotangent function, <span class="math inline">\(\sinh(\cdot)\)</span> is the hyperbolic sine function, and <span class="math inline">\(\cosh(\cdot)\)</span> is the hyperbolic cosine function. Note that we omit <span class="math inline">\(\lambda\)</span> for simplicity but keep in mind that <span class="math inline">\(R(0), T(X), S, K, R_g, a, b\)</span> are all spectral quantities.</p>
<p><a href="#eq-km" class="quarto-xref">Equation&nbsp;<span>15.18</span></a> is the famous K-M model. Consider the case where the material is purely absorptive and scatters little (e.g., dyes on textiles or fabrics), so <span class="math inline">\(S\)</span> is close to 0 and the reflectance is simplified to:</p>
<p><span id="eq-kmabs"><span class="math display">\[
\begin{align}
    R(0) = R_g e^{-2KX} = e^{-KX} R_g e^{-KX}.
\end{align}
\tag{15.19}\]</span></span></p>
<p>We can understand <span class="math inline">\(R_X\)</span> by decomposing it into the product of three terms, each representing a step in the overall, observed reflection. First, photons go through the material from the top down, being absorbed as they go. The percentage of photons that are still left (i.e., unabsorbed) just before they hit the substrate is <span class="math inline">\(e^{-KX}\)</span>, which is consistent with the Beer-Lambert law. Second, the substrate reflects <span class="math inline">\(R_g\)</span> amount of light back toward the material. Finally, as the photons make their way back to the surface, they go through another round of absorption governed by the same Beer-Lambert law (<a href="rendering-sss.html#sec-chpt-mat-vs-abs-simple" class="quarto-xref"><span>Section 13.1.1</span></a>).</p>
<p>Now consider the case where there is no substrate or when the substrate is a perfect black substrate; in both cases <span class="math inline">\(R_g = 0\)</span>. Reflectance is now:</p>
<p><span id="eq-black"><span class="math display">\[
\begin{align}
    R_{black} = \frac{1}{a+b\coth(bSX)}.
\end{align}
\tag{15.20}\]</span></span></p>
<p>Finally, consider the case where the material is so thick that no photon reaches the substrate. In this case, the reflectance is not affected by the substrate and can be simplified to (by letting <span class="math inline">\(X\)</span> approach infinity):</p>
<p><span id="eq-hide"><span class="math display">\[
\begin{align}
    \lim_{X \rightarrow \infty} = R_{\infty} = \frac{1}{a+b} = 1 + \frac{K}{S} - \sqrt{\Big(\frac{K}{S}\Big)^2 + 2 \frac{K}{S}}.
\end{align}
\tag{15.21}\]</span></span></p>
<p>In the painting industry, we say the paint’s “hiding is complete” when the substrate does not influence the material color. We can quantify the “hiding power” of a paint by <span class="math inline">\(H = \frac{R_{white}}{R_{black}}\)</span>, i.e., the ratio of reflectance between when the substrate is black (absorbs everything) and white (reflects everything back). If the hiding is complete, <span class="math inline">\(H\)</span> would be 1.</p>
<p>You might be wondering how we know <span class="math inline">\(K\)</span> and <span class="math inline">\(S\)</span> of a material — we measure them. For instance, observe <a href="#eq-black" class="quarto-xref">Equation&nbsp;<span>15.20</span></a> and <a href="#eq-hide" class="quarto-xref">Equation&nbsp;<span>15.21</span></a>; we can measure the reflectance <span class="math inline">\(R_{black}\)</span> when the substrate is nearly black and the reflectance <span class="math inline">\(R_{\infty}\)</span> when the hiding is near complete. We can then solve the system of equations to estimate <span class="math inline">\(K\)</span> and <span class="math inline">\(S\)</span>.</p>
<p>You can see that we are not actually taking a very thin layer of particles, illuminating it, and then measuring how much of the light is scattered vs.&nbsp;absorbed. Instead, we estimate <span class="math inline">\(K\)</span> and <span class="math inline">\(S\)</span> macroscopically. We have in mind a model (a set of equations or functions, if you will) that is parameterized by unknown variables. We then probe the model by giving it different inputs and measuring the outputs. From the input-output pairs, we can then estimate the unknown parameters. This is why a model so defined and derived is called a phenomenological model and the parameters (e.g., the <span class="math inline">\(K\)</span> and <span class="math inline">\(S\)</span> coefficients) are called the phenomenological parameters — because all we do is to observe the phenomena.</p>
</section>
<section id="sec-chpt-mat-vs-km-mix" class="level3" data-number="15.1.3">
<h3 data-number="15.1.3" class="anchored" data-anchor-id="sec-chpt-mat-vs-km-mix"><span class="header-section-number">15.1.3</span> K-M Model for Mixture of Materials</h3>
<p>The basic K-M model can be extended to account for materials that consist of a mixture of materials, each with different absorption/scattering behaviors. This is done by first expressing the overall absorption and scattering coefficients of the mixture and then plugging them into the K-M model.</p>
<p>Specifically, if we are mixing <span class="math inline">\(N\)</span> materials, each with a phenomenological absorption and scattering coefficient <span class="math inline">\(K_i\)</span> and <span class="math inline">\(S_i\)</span>, the overall absorption and scattering coefficient of the material is:</p>
<p><span id="eq-ks_mix"><span class="math display">\[
\begin{align}
    K &amp;= \sum_{i=1}^N \eta_i K_i, \label{eq:ks_mix_k} \\
    S &amp;= \sum_{i=1}^N \eta_i S_i, \label{eq:ks_mix_s}
\end{align}
\tag{15.22}\]</span></span></p>
<p>where <span class="math inline">\(\eta_i\)</span> is the <em>volume concentration</em> of the <span class="math inline">\(i^{th}\)</span> material in the overall material mixture and is defined as:</p>
<p><span class="math display">\[
\begin{align}
    \eta_i = \frac{V_i}{\sum_{j=1}^N V_j},
\end{align}
\]</span></p>
<p>where <span class="math inline">\(V_j\)</span> is the volume of the <span class="math inline">\(j^{th}\)</span> material. Once we have the <span class="math inline">\(K\)</span> and <span class="math inline">\(S\)</span> coefficients, we simply invoke <a href="#eq-km" class="quarto-xref">Equation&nbsp;<span>15.18</span></a> to calculate the reflectance/transmittance of the material mixture.</p>
<p>Why would it make sense to calculate the overall <span class="math inline">\(K\)</span> and <span class="math inline">\(S\)</span> using the volume-weighting method in <a href="#eq-ks_mix" class="quarto-xref">Equation&nbsp;<span>15.22</span></a>? Let’s derive it using absorption as an example. The overall absorption coefficient <span class="math inline">\(K\)</span> of the material mixture is also the optical absorption coefficient <span class="math inline">\(\sigma_a\)</span> of the mixture (given the set of assumptions we have made so far; see <a href="#eq-km_abs_approx" class="quarto-xref">Equation&nbsp;<span>15.15</span></a>), which is given by <a href="rendering-sss.html#eq-absorbances_add" class="quarto-xref">Equation&nbsp;<span>13.11</span></a> as:</p>
<p><span class="math display">\[
\begin{align}
    K = \sigma_a = \sum_i^N c^i\epsilon^i,
\end{align}
\]</span></p>
<p>where <span class="math inline">\(c^i\)</span> and <span class="math inline">\(\epsilon^i\)</span> are the number concentration and the absorption cross section of the <span class="math inline">\(i^{th}\)</span> material in the material mixture. Specifically, <span class="math inline">\(c^i\)</span> is defined as:</p>
<p><span id="eq-num_conc"><span class="math display">\[
\begin{align}
    c^i = \frac{n_i}{\sum_{j=1}^N V_j} = \frac{V_i}{\sum_{j=1}^N V_j} \frac{n_i}{V_i},
\end{align}
\tag{15.23}\]</span></span></p>
<p>where <span class="math inline">\(n_i\)</span> is the number of particles of the <span class="math inline">\(i^{th}\)</span> material in the mixture. We assume that when we mix <span class="math inline">\(N\)</span> materials, their volumes add. That is, the volume of the mixture is the sum of that of the individual materials. This is in general true if different materials do not chemically react and if materials do not dissolve into each other. Therefore:</p>
<p><span id="eq-k_mix_2"><span class="math display">\[
\begin{align}
    K = \sum_i^N c^i\epsilon^i \label{eq:k_mix_1} = \sum_i^N \frac{V_i}{\sum_{j=1}^N V_j} \frac{n_i}{V_i} \epsilon^i = \sum_i^N \eta_i \frac{n_i}{V_i} \epsilon^i.
\end{align}
\tag{15.24}\]</span></span></p>
<p>We then, again, use the fact (<a href="#eq-km_abs_approx" class="quarto-xref">Equation&nbsp;<span>15.15</span></a>) that the phenomenological absorption coefficient of the <span class="math inline">\(i^{th}\)</span> material <span class="math inline">\(K_i\)</span> is the same as its optical absorption coefficient <span class="math inline">\(\sigma_{a, i} = c_i \epsilon_i\)</span>, where:</p>
<ul>
<li><span class="math inline">\(c_i = \frac{n_i}{V_i}\)</span> is the number concentration of the <span class="math inline">\(i^{th}\)</span> material <em>on its own</em> (note the subtle difference of <span class="math inline">\(c_i\)</span> here and <span class="math inline">\(c^i\)</span> in <a href="#eq-num_conc" class="quarto-xref">Equation&nbsp;<span>15.23</span></a>, which is the number concentration of the <span class="math inline">\(i^{th}\)</span> material in a mixture), and</li>
<li><span class="math inline">\(\epsilon_i\)</span> is just <span class="math inline">\(\epsilon^i\)</span>: they both refer to absorption cross section of the <span class="math inline">\(i^{th}\)</span> material, which does not change whether the material is in a mixture or not.</li>
</ul>
<p>Therefore: <span id="eq-k_mix_3"><span class="math display">\[
\begin{align}
    K = \sum_i^N \eta_i c_i \epsilon_i = \sum_i^N \eta_i K_i,
\end{align}
\tag{15.25}\]</span></span></p>
<p>which is exactly <a href="#eq-ks_mix" class="quarto-xref">Equation&nbsp;<span>15.22</span></a>.</p>
</section>
<section id="sec-chpt-mat-vs-km-cor" class="level3" data-number="15.1.4">
<h3 data-number="15.1.4" class="anchored" data-anchor-id="sec-chpt-mat-vs-km-cor"><span class="header-section-number">15.1.4</span> Correction for Surface Reflection</h3>
<p>One thing that is ignored in the K-M model is the surface reflection/refraction yet. Part of the photons will be reflected away at the air/material interface before they enter the material. Similarly, when we consider the transmittance, we have ignored the reflection/refraction at the other side of the material. So the reflectance and transmittance calculated by the K-M model are defined at the point when the photons are just about to leave the material.</p>
<p>To account for the surface phenomena, we can apply what is called the Saunderson correction, derived by <span class="citation" data-cites="saunderson1942calculation">Saunderson (<a href="references.html#ref-saunderson1942calculation" role="doc-biblioref">1942</a>)</span>. See <span class="citation" data-cites="sharma2003color">Sharma (<a href="references.html#ref-sharma2003color" role="doc-biblioref">2003</a>, Chpt. 3.6.3)</span> for a derivation, but briefly, if the illumination is diffuse, the corrected surface reflectance is:</p>
<p><span class="math display">\[
\begin{align}
    R = r_s + \frac{(1-r_s)(1-r_i)~R(0)}{1-r_i~R(0)},
\end{align}
\]</span></p>
<p>where <span class="math inline">\(R(0)\)</span> is the reflectance given by the K-M model, <span class="math inline">\(r_s\)</span> is the fraction of incident irradiance scattered by the air-material surface, and <span class="math inline">\(r_i\)</span> is the fraction of the internal irradiance approaching the air-material interface that is scattered back by the interface. Assuming a smooth surface, both <span class="math inline">\(r_s\)</span> and <span class="math inline">\(r_i\)</span> can be calculated by the Fresnel equations given the refractive index of the material (<a href="rendering-surfacemodeling.html#sec-chpt-mat-ss-mat" class="quarto-xref"><span>Section 12.1</span></a>).</p>
</section>
</section>
<section id="sec-chpt-mat-vs-km-nflux" class="level2" data-number="15.2">
<h2 data-number="15.2" class="anchored" data-anchor-id="sec-chpt-mat-vs-km-nflux"><span class="header-section-number">15.2</span> The N-Flux Model</h2>
<p>The basic K-M model is called the two-stream or two-flux model, because it considers only the total upward irradiance and total downward irradiance. We basically have divided all the directions possible in the space into only two solid angles, the upper hemisphere and the lower hemisphere. What if we want to know the irradiance at a finer granularity (i.e., over a smaller solid angle)? We divide all the directions into more solid angles and analyze the irradiance change in them using a similar method.</p>
<p>For instance, if we now consider irradiance in four directions: <span class="math inline">\(E_{\nwarrow}(x)\)</span>, <span class="math inline">\(E_{\nearrow}(x)\)</span>, <span class="math inline">\(E_{\searrow}(x)\)</span>, and <span class="math inline">\(E_{\swarrow}(x)\)</span>, we can write the change of the irradiance in <span class="math inline">\(E_{\searrow}(x)\)</span> as:</p>
<p><span id="eq-n_stream_se"><span class="math display">\[
\begin{align}
    \frac{\d E_{\searrow}(x)}{\d x} = &amp; - K_{\searrow}(x) E_{\searrow}(x) \nonumber \\
    &amp; + S_{\nwarrow\searrow}(x) E_{\nwarrow}(x) + S_{\nearrow\searrow}(x) E_{\nearrow}(x) + S_{\swarrow\searrow}(x) E_{\swarrow}(x) \nonumber \\
    &amp; - S_{\searrow\nwarrow}(x) E_{\searrow}(x) - S_{\searrow\nearrow}(x) E_{\searrow}(x) - S_{\searrow\swarrow}(x) E_{\searrow}(x),
\end{align}
\tag{15.26}\]</span></span></p>
<p>where <span class="math inline">\(S_{\nwarrow\searrow}\)</span> is the scattering coefficient of from the northwest irradiance to the southeast direction, and so on. We can express the changes of the other three directions similarly. In general, if we divide the space into <span class="math inline">\(N\)</span> “channels”, each representing a set of directions (a finite solid angle), we can extend the two-flux model to a “N-flux” model.</p>
<div id="fig-n_flux" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-n_flux-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figs/n_flux.svg" class="img-fluid figure-img" style="width:50.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-n_flux-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.2: The setup for the N-flux model. All the possible directions (consider all the arrows that can possibly go out from the origin) are divided into “channels” or “streams”, each of which represents a finite solid angle within which an irradiance travels. The N-flux model models the changes of each of these irradiances. Adapted from <span class="citation" data-cites="li2003ink">Li (<a href="references.html#ref-li2003ink" role="doc-biblioref">2003, fig. 4.1</a>)</span>.
</figcaption>
</figure>
</div>
<p><a href="#fig-n_flux" class="quarto-xref">Figure&nbsp;<span>15.2</span></a> shows the setup for deriving the N-flux model, where all the possible directions (consider all the arrows that can possibly go out from the origin) are divided into “channels” or “streams”, each of which represents a finite solid angle within which an irradiance travels. The figure visualizes eight such channels. The change of each channel is modeled by taking away from each channel photons that are absorbed and scattered to all other channels and by adding photons scattered into the channel from all other channels. In the end, we get <span class="math inline">\(N\)</span> linear differential equations. <a href="#eq-n_stream_se" class="quarto-xref">Equation&nbsp;<span>15.26</span></a> is one such equation when <span class="math inline">\(N=4\)</span>. The channels are usually rotationally symmetric about the <span class="math inline">\(z\)</span>-axis, assuming that the material is rotationally symmetric about the <span class="math inline">\(z\)</span>-axis.</p>
<p>Comparing against the RTE in <a href="rendering-rte.html#eq-rte_2" class="quarto-xref">Equation&nbsp;<span>14.7</span></a>, which has an integral term <span class="math inline">\(L_s\)</span> given in <a href="rendering-rte.html#eq-source_term_em" class="quarto-xref">Equation&nbsp;<span>14.4</span></a>. What the N-flux model does is to essentially approximate that integral with a finite sum. In general, the larger the <span class="math inline">\(N\)</span> the better the approximation but also the more computationally intensive to solve. We will omit a formal treatment but refer you to <span class="citation" data-cites="bohren2006fundamentals">Bohren and Clothiaux (<a href="references.html#ref-bohren2006fundamentals" role="doc-biblioref">2006</a>, Chpt. 6.1)</span>, <span class="citation" data-cites="volz2001industrial">Volz and Simon (<a href="references.html#ref-volz2001industrial" role="doc-biblioref">2001</a>, Chpt. 3.1.2)</span>, and <span class="citation" data-cites="klein2010industrial">Klein (<a href="references.html#ref-klein2010industrial" role="doc-biblioref">2010</a>, Chpt. 5.5)</span> for details.</p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-bohren2006fundamentals" class="csl-entry" role="listitem">
Bohren, Craig F, and Eugene E Clothiaux. 2006. <em>Fundamentals of Atmospheric Radiation: An Introduction with 400 Problems</em>. John Wiley &amp; Sons.
</div>
<div id="ref-klein2010industrial" class="csl-entry" role="listitem">
Klein, GA. 2010. <span>“Industrial Color Physics.”</span> Springer Science+ Business Media.
</div>
<div id="ref-kubelka1948new" class="csl-entry" role="listitem">
Kubelka, Paul. 1948. <span>“New Contributions to the Optics of Intensely Light-Scattering Materials. Part i.”</span> <em>Josa</em> 38 (5): 448–57.
</div>
<div id="ref-kubelka1931article" class="csl-entry" role="listitem">
Kubelka, Paul, and Franz Munk. 1931a. <span>“An Article on Optics of Paint Layers (Translated by Stephen h. Westin).”</span> <em>Z. Tech. Phys</em> 12 (593-601): 259–74.
</div>
<div id="ref-kubelka1931beitrag" class="csl-entry" role="listitem">
———. 1931b. <span>“Ein Beitrag Zur Optik Der Farbanstriche.”</span> <em>Z. Tech. Phys</em> 12:593–601.
</div>
<div id="ref-li2003ink" class="csl-entry" role="listitem">
Li, Yang. 2003. <span>“Ink-Paper Interaction-a Study in Ink-Jet Color Reproduction.”</span> <em>Institute of Technology-Link<span>ö</span>pings University. Norrk<span>ö</span>ping, Sweden: UniTryck</em>.
</div>
<div id="ref-saunderson1942calculation" class="csl-entry" role="listitem">
Saunderson, JL. 1942. <span>“Calculation of the Color of Pigmented Plastics.”</span> <em>JOSA</em> 32 (12): 727–36.
</div>
<div id="ref-sharma2003color" class="csl-entry" role="listitem">
Sharma, Gaurav. 2003. <span>“Color Fundamentals for Digital Imaging.”</span> In <em>Digital Color Imaging Handbook</em>, edited by Gaurav Sharma, 14–127. CRC Press.
</div>
<div id="ref-volz2001industrial" class="csl-entry" role="listitem">
Volz, Hans G, and Frederick T Simon. 2001. <em>Industrial Color Testing</em>. Vol. 2. Wiley-VCH New York.
</div>
</div>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>which says that there exists <span class="math inline">\(c\in [a, b]\)</span> such that <span class="math inline">\(\int_a^b f(x)g(x)\d x = f(c)\int_a^b g(x)\d x\)</span>, if <span class="math inline">\(g(x)\)</span> is integrable and does not change its sign in <span class="math inline">\([a, b]\)</span>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>If <span class="math inline">\(L(x, \omega)\)</span> is invariant to <span class="math inline">\(\omega\)</span> and <span class="math inline">\(f_p(x, \omega', \hat{\omega})\)</span>, under the isotropic medium assumption, is reduced to <span class="math inline">\(f_p(x, \theta)\)</span>, where <span class="math inline">\(\theta\)</span> is the angle subtended by <span class="math inline">\(\omega\)</span> and <span class="math inline">\(\omega'\)</span>, both <span class="math inline">\(S_{\uparrow\downarrow}(x)\)</span> and <span class="math inline">\(S_{\downarrow\uparrow}(x)\)</span> are essentially calculating <span class="math inline">\(\int^{\pi}\int^{\pi}c~\d \theta\d \theta'\)</span>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>You can see that <span class="math inline">\(T(X)\)</span> does not involve <span class="math inline">\(R_g\)</span>: when we calculate the transmittance of the material, we assume that there is no substrate.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./rendering-rte.html" class="pagination-link" aria-label="Radiative Transfer Equation and Volume Rendering">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Radiative Transfer Equation and Volume Rendering</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./imaging.html" class="pagination-link" aria-label="Imaging">
        <span class="nav-page-text">Imaging</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>